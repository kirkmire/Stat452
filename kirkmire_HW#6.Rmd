---
title: 'HW #6'
author: "Colin Kirkmire"
date: "April 9, 2016"
output: html_document
---


```{r setup, include=FALSE}
 sat <- read.csv("C:/Users/Colin/Desktop/Rprojects/Stat452/sat.csv")

sat.lm<-lm(sat$SAT~sat$Takers+sat$Rank)

#Check residuals#

plot(resid(sat.lm)~predict(sat.lm))
hist(resid(sat.lm),col="gray")
qqnorm(resid(sat.lm))

#Try log transformation#
plot(sat$SAT~log(sat$Takers))
plot(sat$SAT~(sat$Rank))

sq.sat.lm<-lm(sat$SAT~log(sat$Takers)+sat$Rank^2)


#Re-Check residuals#

plot(resid(sq.sat.lm)~predict(sq.sat.lm))
hist(resid(sq.sat.lm),col="gray")
qqnorm(resid(sq.sat.lm))


summary(sat.lm)
```

(a)
```{r}
#Relationship between SAT,Takers and Ranks#
rel.sat<-sat[,c('SAT','Takers','Rank')]

library(GGally)
ggpairs(rel.sat)
```

There is a strong, negative relationship between the Takers variable and SAT. However, the Taker's variable appears to be decrease exponentially as statewide average SAT increases.
As the percent of high school students who took the SAT increases, the state's average total score decreases exponentially. 

In contrast, there is a strong positive  relationship between Rank and SAT.  The state's average total SAT score increases as the median percentile rank of test-takers increases. 

The relationship between rank and takers appears to be very strong (r=-.94) and negatively linear. When the percent of a state's high schoolers who take the SAT increases, the median percentile rank of test-takers decreases.  

##CHECK for outliers##
Rank does not appear to be linearly related to residual (r=1.3^-16). In fact, all of the variables have an apparent lack of linearity with residuals.  SAT has the highest correlation (.43) with resid.  This means that states with higher SAT scores tend to have a higher raw residual according to the model.

The states with the lowest SAT scores (South Carolina, Georgia and North Carolina) appears as an outliers in 

(b)
```{r}
b.sat.lm<-lm(sat$SAT~sat$Takers+sat$Rank)

plot(resid(b.sat.lm)~b.sat.lm$fitted.values)

library(car)
crPlots(b.sat.lm)

```

(c)
```{r}
log.sat.lm<-lm(sat$SAT~log(sat$Takers)+sat$Rank)

plot(resid(log.sat.lm)~log.sat.lm$fitted.values)

library(car)
crPlots(log.sat.lm)
```

(d)
```{r}
#Fit model with log(Takers) and Rank (no interaction)#

logt.sat.lm<-lm(sat$SAT~log(sat$Takers)+sat$Rank)

sat$resid<-(resid(logt.sat.lm))

ordered.sat<-sat[order(logt.sat.lm$resid),]

```
South Carolina,North Carolina and Mississippi performed worst after adjusting for the number and quality of students taking the test.  The top performing states were New Hampshire, Iowa and Connecticut.


(e)
```{r}
#Relationship between Expend, Years and Income#
rel.expend.years.income<-sat[,c('Years','Expend','Income','resid','State')]

library(GGally)
ggpairs(rel.expend.years.income[,1:4])

mean(rel.expend.years.income$Expend)

sd(rel.expend.years.income$Expend)


```
The correlation coeficient of income vs residual (.135) suggests that there is a lack of linear relationship between these variables.  This suggests that median family income is not related to the residual.  However, Years and Expenditure  appear to have stronger positive linear relationships with the residuals albeit these are not very strong relationships  (.41 and .50 respectively).  

Years is not stongly correlated with expenditure (r=.0598) or income (r=.135).  This means that both the amount that a state spends per student as well as median test taker family income are not correlated with how many years of formal study that sudents had in social sciences, natural sciences and humanities.

There is an obvious outlier in terms of spending per student in secondary education (Expend).  Alaska spends over $5,000 per student per student. The mean and standard deviation of expenditure is $2,297 and $614, respectively. 

There are also two states that are outlying in regard to median family income vs both years and expend. These states (Alaska and Louisiana) also happen to be the highest states overall in terms of median family income of test-takers.


(f)
```{r}

#Fit model with log(Takers) model w Expend, Income and Years#

f.logt.sat.lm<-lm(SAT~log(Takers)+Rank+Expend+Years, data=sat)

plot(resid(f.logt.sat.lm)~f.logt.sat.lm$fitted.values)

#Cooks Distance#
plot(f.logt.sat.lm,which=c(4))

#leverage#
lev<-hat(model.matrix(f.logt.sat.lm))

plot(lev)


library(car)
crPlots(f.logt.sat.lm)


```
Alaska has the highest expenditure per student by a large amount.  Anecdotely, I have heard that much of the money spent on high school students in ALaska involves transporting them to various extracurricular events. Bringing teams together for athletic competitions may involve flying the entire basketball team to another location since the state is so vast and schools are often otherwise virtually inaccesible.

This increase in state ependiture per student for travel cost will likely be of little use in a model for state SAT scores and will only serve to "pull" the least squares reggression line towards it since it has such a high leverage. Therefore it is justified to remove Alaska from the model.

(g)
```{r}
#fit w/o Alaska#
sat.sansAK<-sat[!sat$State==('Alaska'),]

sansAK.lm<-lm(SAT~log(Takers)+Rank+Expend+Years+Income, data=sat.sansAK)

#Refitting model from Part D#
logt.sansAK.lm<-lm(SAT~log(Takers)+Rank, data=sat.sansAK)

#Partial F-test#
anova(sansAK.lm,logt.sansAK.lm)

```
The large F-statistic provides strong evidence that at least one of the variables added in the model that includes the three variables (Expend, Years, and Income) results in a statistically different model.


(h)
```{r}
sansAK.sum<-summary(sansAK.lm)

#Confidence intervals for coefficients#

confint(sansAK.lm,level=.95)

```

(i)
```{r}
red.sat.lm<-lm(SAT~log(Takers)+Rank+Expend,data=sat.sansAK)

woIncome.sum<-summary(red.sat.lm)

#Expend CI#
woIncome.sum$coefficients[4]+c(-1,1)*woIncome.sum$coefficients[4,2]*woIncome.sum$coefficients[4,3]

```
ans=given income vs not given income


(j)
```{r}
library(robustbase)


robust.lm<-lmrob(SAT~log(Takers)+Rank+Expend+Years+Income, data=sat)

confint(robust.lm,level=.95)

robust.lm$rweights[29]

```
A weight of zero was assigned to Alaska by the robust regression function.  The outlier therefore did not contribute to the robust regression model.





















